---
// Pre-renderizar esta página estáticamente
export const prerender = true;

import KitchenLayout from "../../layouts/KitchenLayout.astro";
---

<KitchenLayout title="Vista de Cocina">
  <div class="h-full flex flex-col">
    <!-- Header de la Vista de Cocina -->
    <div class="flex justify-between items-center mb-6">
      <div class="flex items-center gap-4">
        <div class="p-3 bg-orange-600/20 rounded-lg">
          <svg class="w-8 h-8 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <div>
          <h1 class="font-heading text-3xl font-bold text-text-primary">Vista de Cocina</h1>
          <p class="text-text-secondary">Gestión de comandas en tiempo real</p>
        </div>
      </div>
      
      <!-- Indicadores de Estado y Controles -->
      <div class="flex items-center gap-4">
        <!-- Estado de Conexión -->
        <div class="flex items-center gap-2">
          <div id="connection-indicator" class="w-3 h-3 bg-gray-500 rounded-full animate-pulse"></div>
          <span id="connection-status" class="text-text-secondary text-sm">Conectando...</span>
        </div>
        
        <!-- Contador Total de Pedidos Activos -->
        <div class="text-center">
          <p class="text-text-secondary text-sm">Activos</p>
          <p id="total-orders-count" class="text-xl font-bold text-text-primary">0</p>
        </div>

        <!-- Contador de Pedidos Completados Hoy -->
        <div class="text-center">
          <p class="text-text-secondary text-sm">Completados</p>
          <p id="completed-today-count" class="text-xl font-bold text-green-400">0</p>
        </div>

        <!-- Control de Audio -->
        <button 
          id="audio-toggle-btn"
          class="bg-surface border border-white/20 text-text-primary hover:bg-white/5 p-2 rounded-lg transition-colors"
          title="Activar/Desactivar sonidos"
        >
          <svg id="audio-on-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 14.142M8.5 6.5H6a2 2 0 00-2 2V15.5a2 2 0 002 2h2.5l4.5 3v-16l-4.5 3z"></path>
          </svg>
          <svg id="audio-off-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path>
          </svg>
        </button>

        <!-- Botón de Historial -->
        <button 
          id="history-btn"
          class="bg-blue-600/20 border border-blue-400/30 text-blue-400 hover:bg-blue-600/30 px-3 py-2 rounded-lg transition-colors flex items-center gap-2"
          title="Ver historial del día"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span class="text-sm font-medium">Historial</span>
        </button>
        
        <!-- Botón de Refresh Manual -->
        <button 
          id="refresh-orders-btn"
          class="bg-surface border border-white/20 text-text-primary hover:bg-white/5 p-2 rounded-lg transition-colors"
          title="Actualizar pedidos"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Kanban Board de Comandas -->
    <div class="flex-1 flex gap-6 min-h-0">
      <!-- Columna: Pendiente -->
      <div class="flex-1 bg-surface rounded-xl p-4 border border-white/10 min-w-0">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
            <h2 class="font-heading text-lg font-semibold text-text-primary">Pendiente</h2>
            <span id="pending-count" class="bg-yellow-600/20 text-yellow-400 text-xs px-2 py-1 rounded-full font-medium">0</span>
          </div>
          <div class="text-xs text-text-secondary">
            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Nuevos pedidos
          </div>
        </div>
        
        <!-- Container de Pedidos Pendientes -->
        <div id="pending-orders" class="space-y-3 overflow-y-auto max-h-full">
          <!-- Loading inicial -->
          <div id="pending-loading" class="space-y-3">
            <div class="bg-background p-4 rounded-lg animate-pulse">
              <div class="h-4 bg-gray-600 rounded w-3/4 mb-2"></div>
              <div class="h-3 bg-gray-600 rounded w-1/2 mb-3"></div>
              <div class="h-8 bg-gray-600 rounded w-full"></div>
            </div>
            <div class="bg-background p-4 rounded-lg animate-pulse">
              <div class="h-4 bg-gray-600 rounded w-2/3 mb-2"></div>
              <div class="h-3 bg-gray-600 rounded w-1/3 mb-3"></div>
              <div class="h-8 bg-gray-600 rounded w-full"></div>
            </div>
          </div>
          
          <!-- Empty state -->
          <div id="pending-empty" class="hidden text-center py-12">
            <svg class="w-12 h-12 text-text-secondary mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z"></path>
            </svg>
            <p class="text-text-secondary">No hay pedidos pendientes</p>
          </div>
        </div>
      </div>

      <!-- Columna: En Preparación -->
      <div class="flex-1 bg-surface rounded-xl p-4 border border-white/10 min-w-0">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
            <h2 class="font-heading text-lg font-semibold text-text-primary">En Preparación</h2>
            <span id="inPreparation-count" class="bg-blue-600/20 text-blue-400 text-xs px-2 py-1 rounded-full font-medium">0</span>
          </div>
          <div class="text-xs text-text-secondary">
            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            Cocinando
          </div>
        </div>
        
        <!-- Container de Pedidos En Preparación -->
        <div id="inPreparation-orders" class="space-y-3 overflow-y-auto max-h-full">
          <!-- Loading inicial -->
          <div id="inPreparation-loading" class="space-y-3">
            <div class="bg-background p-4 rounded-lg animate-pulse">
              <div class="h-4 bg-gray-600 rounded w-3/4 mb-2"></div>
              <div class="h-3 bg-gray-600 rounded w-1/2 mb-3"></div>
              <div class="h-8 bg-gray-600 rounded w-full"></div>
            </div>
          </div>
          
          <!-- Empty state -->
          <div id="inPreparation-empty" class="hidden text-center py-12">
            <svg class="w-12 h-12 text-text-secondary mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            <p class="text-text-secondary">No hay pedidos en preparación</p>
          </div>
        </div>
      </div>

      <!-- Columna: Listo -->
      <div class="flex-1 bg-surface rounded-xl p-4 border border-white/10 min-w-0">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
            <h2 class="font-heading text-lg font-semibold text-text-primary">Listo</h2>
            <span id="ready-count" class="bg-green-600/20 text-green-400 text-xs px-2 py-1 rounded-full font-medium">0</span>
          </div>
          <div class="text-xs text-text-secondary">
            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Para entregar
          </div>
        </div>
        
        <!-- Container de Pedidos Listos -->
        <div id="ready-orders" class="space-y-3 overflow-y-auto max-h-full">
          <!-- Loading inicial -->
          <div id="ready-loading" class="space-y-3">
            <div class="bg-background p-4 rounded-lg animate-pulse">
              <div class="h-4 bg-gray-600 rounded w-3/4 mb-2"></div>
              <div class="h-3 bg-gray-600 rounded w-1/2 mb-3"></div>
              <div class="h-8 bg-gray-600 rounded w-full"></div>
            </div>
          </div>
          
          <!-- Empty state -->
          <div id="ready-empty" class="hidden text-center py-12">
            <svg class="w-12 h-12 text-text-secondary mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-text-secondary">No hay pedidos listos</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast de Notificaciones Específico para Cocina -->
    <div id="kitchen-notifications" class="fixed top-4 right-4 space-y-2 z-50 pointer-events-none">
      <!-- Las notificaciones de nuevos pedidos aparecerán aquí -->
    </div>

    <!-- Modal de Historial -->
    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-surface rounded-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
          <!-- Header del Modal -->
          <div class="flex justify-between items-center p-6 border-b border-white/10">
            <div>
              <h2 class="font-heading text-xl font-bold text-text-primary">Historial del Día</h2>
              <p class="text-text-secondary text-sm">Pedidos completados hoy</p>
            </div>
            <button 
              id="close-history-btn"
              class="text-text-secondary hover:text-text-primary p-2 rounded-lg hover:bg-white/5 transition-colors"
            >
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>

          <!-- Estadísticas del día -->
          <div class="p-6 border-b border-white/10">
            <div class="grid grid-cols-3 gap-6">
              <div class="text-center">
                <p class="text-2xl font-bold text-green-400" id="history-completed-count">0</p>
                <p class="text-text-secondary text-sm">Completados</p>
              </div>
              <div class="text-center">
                <p class="text-2xl font-bold text-blue-400" id="history-avg-time">0min</p>
                <p class="text-text-secondary text-sm">Tiempo Promedio</p>
              </div>
              <div class="text-center">
                <p class="text-2xl font-bold text-purple-400" id="history-total-items">0</p>
                <p class="text-text-secondary text-sm">Platos Preparados</p>
              </div>
            </div>
          </div>

          <!-- Lista de Pedidos -->
          <div class="flex-1 p-6 overflow-y-auto">
            <div id="history-loading" class="text-center py-12">
              <div class="animate-pulse">
                <div class="w-16 h-16 bg-gray-600 rounded-full mx-auto mb-4"></div>
                <div class="h-4 bg-gray-600 rounded w-1/4 mx-auto"></div>
              </div>
            </div>

            <div id="history-list" class="space-y-4 hidden">
              <!-- Los pedidos del historial aparecerán aquí -->
            </div>

            <div id="history-empty" class="text-center py-12 hidden">
              <div id="history-empty-icon" class="mx-auto mb-4">
                <!-- Icono por defecto: Empty state (sin pedidos) -->
                <svg class="w-16 h-16 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                </svg>
              </div>
              <p id="history-empty-text" class="text-text-secondary">No hay pedidos completados hoy</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Audio Elements -->
    <audio id="new-order-sound" preload="auto">
      <source src="/sounds/new-order.mp3" type="audio/mpeg">
      <source src="/sounds/new-order.wav" type="audio/wav">
    </audio>
    
    <audio id="order-ready-sound" preload="auto">
      <source src="/sounds/order-ready.mp3" type="audio/mpeg">
      <source src="/sounds/order-ready.wav" type="audio/wav">
    </audio>
  </div>

  <!-- Scripts -->
  <script src="../../scripts/kitchen-page.ts"></script>
</AdminLayout>

<style>
  /* Animaciones personalizadas para la cocina */
  @keyframes pulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: .5;
    }
  }

  @keyframes newOrderPulse {
    0%, 100% {
      box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7);
    }
    50% {
      box-shadow: 0 0 0 10px rgba(251, 191, 36, 0);
    }
  }

  @keyframes slideInFromTop {
    from {
      transform: translateY(-100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @keyframes slideOut {
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }

  .new-order-animation {
    animation: newOrderPulse 2s ease-in-out 3, slideInFromTop 0.5s ease-out;
    border: 2px solid rgba(251, 191, 36, 0.5);
  }

  .order-moving {
    transition: all 0.3s ease-in-out;
    transform: scale(0.95);
    opacity: 0.7;
  }

  .kitchen-toast {
    animation: slideInFromTop 0.3s ease-out, slideOut 0.3s ease-in 4.7s;
  }

  /* Estados de conexión */
  .connected { 
    background-color: rgb(16 185 129);
  }
  .connecting { 
    background-color: rgb(245 158 11);
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  .disconnected { 
    background-color: rgb(239 68 68);
  }

  /* Mejoras de scrolling */
  .overflow-y-auto {
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
  }

  .overflow-y-auto::-webkit-scrollbar {
    width: 4px;
  }

  .overflow-y-auto::-webkit-scrollbar-track {
    background: transparent;
  }

  .overflow-y-auto::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 2px;
  }

  .overflow-y-auto::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .flex-1 {
      min-width: 280px;
    }
  }
</style>
